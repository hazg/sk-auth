{"version":3,"file":"auth.js","sources":["../src/auth.ts"],"sourcesContent":["import cookie from \"cookie\";\nimport * as jsonwebtoken from \"jsonwebtoken\";\nimport { join } from \"./path\";\nexport class Auth {\n    config;\n    constructor(config) {\n        this.config = config;\n    }\n    get basePath() {\n        return this.config?.basePath ?? \"/api/auth\";\n    }\n    getJwtSecret() {\n        if (this.config?.jwtSecret) {\n            return this.config?.jwtSecret;\n        }\n        if (this.config?.providers?.length) {\n            const provs = this.config?.providers?.map((provider) => provider.id).join(\"+\");\n            return Buffer.from(provs).toString(\"base64\");\n        }\n        return \"svelte_auth_secret\";\n    }\n    async getToken(headers) {\n        if (!headers.cookie) {\n            return null;\n        }\n        const cookies = cookie.parse(headers.cookie);\n        if (!cookies.svelteauthjwt) {\n            return null;\n        }\n        let token;\n        try {\n            token = (jsonwebtoken.verify(cookies.svelteauthjwt, this.getJwtSecret()) || {});\n        }\n        catch {\n            return null;\n        }\n        if (this.config?.callbacks?.jwt) {\n            token = await this.config.callbacks.jwt(token);\n        }\n        return token;\n    }\n    getBaseUrl(host) {\n        return this.config?.host ?? `http://${host}`;\n    }\n    getPath(path) {\n        const pathname = join([this.basePath, path]);\n        return pathname;\n    }\n    getUrl(path, host) {\n        const pathname = this.getPath(path);\n        return new URL(pathname, this.getBaseUrl(host)).href;\n    }\n    setToken(headers, newToken) {\n        const originalToken = this.getToken(headers);\n        return {\n            ...(originalToken ?? {}),\n            ...newToken,\n        };\n    }\n    signToken(token) {\n        const opts = !token.exp\n            ? {\n                expiresIn: this.config?.jwtExpiresIn ?? \"30d\",\n            }\n            : {};\n        const jwt = jsonwebtoken.sign(token, this.getJwtSecret(), opts);\n        return jwt;\n    }\n    async getRedirectUrl(host, redirectUrl) {\n        let redirect = redirectUrl || this.getBaseUrl(host);\n        if (this.config?.callbacks?.redirect) {\n            redirect = await this.config.callbacks.redirect(redirect);\n        }\n        return redirect;\n    }\n    async handleProviderCallback(request, provider) {\n        const { headers, url } = request;\n        const [profile, redirectUrl] = await provider.callback(request, this);\n        let token = (await this.getToken(headers)) ?? { user: {} };\n        if (this.config?.callbacks?.jwt) {\n            token = await this.config.callbacks.jwt(token, profile);\n        }\n        else {\n            token = this.setToken(headers, { user: profile });\n        }\n        const jwt = this.signToken(token);\n        const redirect = await this.getRedirectUrl(url.host, redirectUrl ?? undefined);\n        return {\n            status: 302,\n            headers: {\n                \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                Location: redirect,\n            },\n        };\n    }\n    async handleEndpoint(request) {\n        const { headers, method, url } = request;\n        if (url.pathname === this.getPath(\"signout\")) {\n            const token = this.setToken(headers, {});\n            const jwt = this.signToken(token);\n            if (method === \"POST\") {\n                return {\n                    headers: {\n                        \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                    },\n                    body: {\n                        signout: true,\n                    },\n                };\n            }\n            const redirect = await this.getRedirectUrl(url.host);\n            return {\n                status: 302,\n                headers: {\n                    \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                    Location: redirect,\n                },\n            };\n        }\n        const regex = new RegExp(join([this.basePath, `(?<method>signin|callback)/(?<provider>\\\\w+)`]));\n        const match = url.pathname.match(regex);\n        if (match && match.groups) {\n            const provider = this.config?.providers?.find((provider) => provider.id === match.groups.provider);\n            if (provider) {\n                if (match.groups.method === \"signin\") {\n                    return await provider.signin(request, this);\n                }\n                else {\n                    return await this.handleProviderCallback(request, provider);\n                }\n            }\n        }\n        return {\n            status: 404,\n            body: \"Not found.\",\n        };\n    }\n    get = async (request) => {\n        const { url } = request;\n        if (url.pathname === this.getPath(\"csrf\")) {\n            return { body: \"1234\" };\n        }\n        else if (url.pathname === this.getPath(\"session\")) {\n            const session = await this.getSession(request);\n            return {\n                body: {\n                    session,\n                },\n            };\n        }\n        return await this.handleEndpoint(request);\n    };\n    post = async (request) => {\n        return await this.handleEndpoint(request);\n    };\n    getSession = async ({ headers }) => {\n        const token = await this.getToken(headers);\n        if (token) {\n            if (this.config?.callbacks?.session) {\n                return await this.config.callbacks.session(token, { user: token.user });\n            }\n            return { user: token.user };\n        }\n        return {};\n    };\n}\n"],"names":[],"mappings":"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"}