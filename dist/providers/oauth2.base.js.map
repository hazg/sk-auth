{"version":3,"file":"oauth2.base.js","sources":["../../src/providers/oauth2.base.ts"],"sourcesContent":["import { Provider } from \"./base\";\nexport class OAuth2BaseProvider extends Provider {\n    async signin(request, auth) {\n        const { method, url } = request;\n        const state = [`redirect=${url.searchParams.get(\"redirect\") ?? this.getUri(auth, \"/\", url.host)}`].join(\",\");\n        const base64State = Buffer.from(state).toString(\"base64\");\n        const nonce = Math.round(Math.random() * 1000).toString();\n        const authUrl = await this.getAuthorizationUrl(request, auth, base64State, nonce);\n        if (method === \"POST\") {\n            return {\n                body: {\n                    redirect: authUrl,\n                },\n            };\n        }\n        return {\n            status: 302,\n            headers: {\n                Location: authUrl,\n            },\n        };\n    }\n    getStateValue(query, name) {\n        if (query.get(\"state\")) {\n            const state = Buffer.from(query.get(\"state\"), \"base64\").toString();\n            return state\n                .split(\",\")\n                .find((state) => state.startsWith(`${name}=`))\n                ?.replace(`${name}=`, \"\");\n        }\n    }\n    async callback({ url }, auth) {\n        const code = url.searchParams.get(\"code\");\n        const redirect = this.getStateValue(url.searchParams, \"redirect\");\n        const tokens = await this.getTokens(code, this.getCallbackUri(auth, url.host));\n        let user = await this.getUserProfile(tokens);\n        if (this.config.profile) {\n            user = await this.config.profile(user, tokens);\n        }\n        return [user, redirect ?? this.getUri(auth, \"/\", url.host)];\n    }\n}\n"],"names":[],"mappings":";;AACO,MAAM,kBAAkB,SAAS,QAAQ,CAAC;AACjD,EAAE,MAAM,MAAM,CAAC,OAAO,EAAE,IAAI,EAAE;AAC9B,IAAI,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,GAAG,OAAO,CAAC;AACpC,IAAI,MAAM,KAAK,GAAG,CAAC,CAAC,SAAS,EAAE,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,UAAU,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,GAAG,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACjH,IAAI,MAAM,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;AAC9D,IAAI,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC,QAAQ,EAAE,CAAC;AAC7D,IAAI,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAAC,OAAO,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,CAAC,CAAC;AACtF,IAAI,IAAI,MAAM,KAAK,MAAM,EAAE;AAC3B,MAAM,OAAO;AACb,QAAQ,IAAI,EAAE;AACd,UAAU,QAAQ,EAAE,OAAO;AAC3B,SAAS;AACT,OAAO,CAAC;AACR,KAAK;AACL,IAAI,OAAO;AACX,MAAM,MAAM,EAAE,GAAG;AACjB,MAAM,OAAO,EAAE;AACf,QAAQ,QAAQ,EAAE,OAAO;AACzB,OAAO;AACP,KAAK,CAAC;AACN,GAAG;AACH,EAAE,aAAa,CAAC,KAAK,EAAE,IAAI,EAAE;AAC7B,IAAI,IAAI,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE;AAC5B,MAAM,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,QAAQ,CAAC,CAAC,QAAQ,EAAE,CAAC;AACzE,MAAM,OAAO,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;AACvG,KAAK;AACL,GAAG;AACH,EAAE,MAAM,QAAQ,CAAC,EAAE,GAAG,EAAE,EAAE,IAAI,EAAE;AAChC,IAAI,MAAM,IAAI,GAAG,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;AAC9C,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;AACtE,IAAI,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;AACnF,IAAI,IAAI,IAAI,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;AACjD,IAAI,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE;AAC7B,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AACrD,KAAK;AACL,IAAI,OAAO,CAAC,IAAI,EAAE,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,GAAG,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;AAChE,GAAG;AACH;;;;"}